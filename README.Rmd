---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# HEgis

<!-- badges: start -->
[![Lifecycle: experimental](https://img.shields.io/badge/lifecycle-experimental-orange.svg)](https://www.tidyverse.org/lifecycle/#experimental)
[![Codecov test coverage](https://codecov.io/gh/lhmet/HEgis/branch/master/graph/badge.svg)](https://codecov.io/gh/lhmet/HEgis?branch=master)
<!-- badges: end -->

The goal of HEgis is to prepare GIS data for use in HydroEngie R&D project. The
main functions of are:

- `import_bhs_ons()`: use it to import the shapefile with basins of major 
hydroelectric power dams.

- `info_station()`: it is useful to get basic information from a ONS station.

- `extract_poly()`: to extract a specific watershed polygon from the data set.



## Installation

You can install HEgis from [github](https://github.com/lhmet/HEgis) with:

``` r
library(devtools)
install_github("lhmet/HEgis")
```

<!-- BEFORE RUN (RE)INSTALL THE PACKAGE -->

We load the required packages using:

```{r}
library(sf)
library(spData)
library(HEgis)
```


## Watersheds

A shapefile with the watersheds of major Hydroelectric Power plants from ONS is 
available with `{HEgis}` package automatically after you install it. The path 
to the compacted file is obtained with the code below:

```{r example}
bhs_rar <- system.file(
  "extdata",
  "BaciasHidrograficasONS_JUNTOS.rar",
  package = "HEgis"
)
bhs_rar
```

We need to extract the `rar` file to import the shapefile. We can do this with `lhmetools::urar()`.

```{r unrar}
if (requireNamespace("lhmetools", quietly = TRUE)) {
  library(lhmetools)
  wherextract <- tempdir() 
  # alternatively you can save in the same path as the compacted file
  #wherextract <- file.path(.libPaths()[1], "HEgis", "extdata")
  (shps <- unrar(bhs_rar, dest_dir = wherextract))
}
```

Now we select the shapefile of interest and then import it.

```{r}
(bhs_shp <- shps[grep("Bacias.*\\.shp$", fs::path_file(shps))])
```


```{r}
bhs_pols <- import_bhs_ons(bhs_shp, quiet = TRUE)
st_crs(bhs_pols) <- 4674
bhs_pols
```

We can view the major watersheds (`r nrow(bhs_pols)`) with:

```{r, fig.align='center', fig.asp = 1}
sa <- world[world$continent == "South America", ]
br <- world[world$name_long == "Brazil", ]

set.seed(12)
ord_areas <- order(bhs_pols$adkm2, decreasing = TRUE)
cols <- sample(colors(), size = nrow(bhs_pols))
plot(st_geometry(sa), 
     axes = TRUE,
     border = "grey", 
     xlim = c(-80, -30),
     ylim = c(-40, 10)
     )
plot(st_geometry(br), axes = TRUE, border = "grey60", lwd = 2, add = TRUE)
# from highest to lower drainage areas
for (i in ord_areas) {
  # i <- ord_areas[1]
  plot(st_geometry(bhs_pols)[i],
    add = TRUE,
    col = cols[i],
    border = 1,
    lwd = 0.7
  )
}

```

Majors HPPs from Paraná River can be selected with:

```{r}
library(tidyverse)
#sort(bhs_pols$nome)
bhs_pr <- filter(bhs_pols, nome %in% 
         c("ITAIPU", "P_PRIMAVERA", "JUPIA", "A_VERMELHA", "BARRA_BONITA", "FURNAS")
       )
bhs_pr
```


```{r, fig.align='center', fig.asp = 1}
set.seed(6)
oa_pr <- order(bhs_pr$adkm2, decreasing = TRUE)
cols <- sample(colors(), size = nrow(bhs_pr))
plot(st_geometry(br), 
     axes = TRUE, 
     border = "grey60", 
     lwd = 2
     #add = TRUE
     )
# from highest to lower drainage areas
for (i in oa_pr) {
  # i <- ord_areas[1]
  plot(st_geometry(bhs_pr)[i],
    add = TRUE,
    col = cols[i],
    border = 1,
    lwd = 0.7
  )
}
```

## Extraction from a specific watershed polygon

To extract a watershed polygon we first need the \"station id\" (posto). We can get this information with the function `info_station()`, for example for the HPP station of **G.B. MUNHOZ** we can use the following code:

```{r}
info_posto <- info_station(name_regex = "MUNHOZ")
info_posto
```
We now use the \"station id\" (posto) to select the polygon of interest.

```{r}
(poly_posto <- extract_poly(station = info_posto$posto))
(area_poly_posto <- poly_posto[["adkm2"]])
```



```{r, eval = FALSE, echo=FALSE}
library(leaflet)
library(leaflet.extras)
library(htmltools)

bhs_pols$nome <- ordered(
  x  = bhs_pols$nome, 
  levels = bhs_pols$nome[order(bhs_pols$adkm2, decreasing = TRUE)]
  )

p <- leaflet() %>%
  addProviderTiles("Esri.NatGeoWorldMap") %>%
  addPolygons(
    data = bhs_pols,
    #group = ~codONS,
    color = "#444444",
    weight = 1,
    smoothFactor = 0.5,
    opacity = 1.0,
    fillOpacity = 0.5,
    # fillColor = ~colorQuantile("YlOrRd", ALAND)(ALAND),
     fillColor = ~colorFactor("Paired", nome)(nome),
    #fillColor = pal,
     #fillColor = ~colorQuantile("YlOrRd", adkm2)(adkm2),
    highlightOptions = highlightOptions(
      color = "white",
      weight = 2,
      bringToFront = FALSE, 
    )
  )
p
```







```{r, fig.align='center', fig.asp = 1, eval = FALSE, echo = FALSE}
ord_areas_cresc <- order(bhs_pols$adkm2)

for(i in ord_areas_cresc){
  # i <- ordem_areas_cresc[1]
plot(sf::st_geometry(sa),
     axes = TRUE,
     border = 'grey', 
     main = paste0(
       bhs_pols$nome[i], 
       " (", bhs_pols$codONS[i], ") ",
       "Área: ",
       round(bhs_pols$adkm2[i]), 
       " km²"
       )
     )
plot(sf::st_geometry(bhs_pols),
     col = NA, 
     border = 'red', lwd = 2,
     add = TRUE
     )
plot(st_geometry(bhs_pols)[i], 
     add = TRUE, 
     col = 1
     )  
}
```

