---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# HEgis

<!-- badges: start -->
[![Lifecycle: experimental](https://img.shields.io/badge/lifecycle-experimental-orange.svg)](https://www.tidyverse.org/lifecycle/#experimental)
<!-- badges: end -->

The goal of HEgis is to prepare GIS data for use in HydroEngie R&D project.

So far now `import_bhs_ons()` is the only function.

## Installation

You can install HEgis from [github](https://github.com/lhmet/HEgis) with:

``` r
library(devtools)
install_github("lhmet/HEgis")
```

<!-- BEFORE RUN (RE)INSTALL THE PACKAGE -->

## Example

A shapefile with the watersheds of major Hydroelectric Power plants from ONS is available with `{HEgis}` package.

```{r example}
library(HEgis)
bhs_rar <- system.file(
  "extdata",
  "BaciasHidrograficasONS_JUNTOS.rar",
  package = "HEgis"
)
```

We need to extract the `rar` file to import the shapefile. We can do this with `lhmetools::urar()`.

```{r unrar}
if (requireNamespace("lhmetools", quietly = TRUE)) {
  (shps <- unrar(bhs_rar))
}
```

Now we select the shapefile of interest and then import it.

```{r}
(bhs_shp <- shps[grep("Bacias.*\\.shp$", fs::path_file(shps))])
```


```{r}
bhs_pols <- import_bhs_ons(bhs_shp)
sf::st_crs(bhs_pols) <- "+proj=longlat +datum=WGS84"
class(bhs_pols)
sf::st_geometry_type(bhs_pols, FALSE)
```

We can view the major watersheds (`r nrow(pols_bhs)`) with:

```{r, fig.align='center', fig.asp = 1}
library(sf)
library(spData)
sa <- world[world$continent == "South America", ]
br <- world[world$name_long == "Brazil", ]

set.seed(12)
ord_areas <- order(pols_bhs$adkm2, decreasing = TRUE)
cols <- sample(colors(), size = nrow(pols_bhs))
plot(sf::st_geometry(sa), 
     axes = TRUE,
     border = "grey", 
     xlim = c(-80, -30),
     ylim = c(-40, 10)
     )
plot(sf::st_geometry(br), axes = TRUE, border = "grey60", lwd = 2, add = TRUE)
# from highest to lower drainage areas
for (i in ord_areas) {
  # i <- ord_areas[1]
  plot(st_geometry(pols_bhs)[i],
    add = TRUE,
    col = cols[i],
    border = 1,
    lwd = 0.7
  )
}

```


```{r, eval = FALSE, echo=FALSE}
library(leaflet)
library(leaflet.extras)
library(htmltools)

pols_bhs$nome <- ordered(
  x  = pols_bhs$nome, 
  levels = pols_bhs$nome[order(pols_bhs$adkm2, decreasing = TRUE)]
  )

p <- leaflet() %>%
  addProviderTiles("Esri.NatGeoWorldMap") %>%
  addPolygons(
    data = pols_bhs,
    #group = ~codONS,
    color = "#444444",
    weight = 1,
    smoothFactor = 0.5,
    opacity = 1.0,
    fillOpacity = 0.5,
    # fillColor = ~colorQuantile("YlOrRd", ALAND)(ALAND),
     fillColor = ~colorFactor("Paired", nome)(nome),
    #fillColor = pal,
     #fillColor = ~colorQuantile("YlOrRd", adkm2)(adkm2),
    highlightOptions = highlightOptions(
      color = "white",
      weight = 2,
      bringToFront = FALSE, 
    )
  )
p
```







```{r, fig.align='center', fig.asp = 1, eval = FALSE, echo = FALSE}
ord_areas_cresc <- order(pols_bhs$adkm2)

for(i in ord_areas_cresc){
  # i <- ordem_areas_cresc[1]
plot(sf::st_geometry(sa),
     axes = TRUE,
     border = 'grey', 
     main = paste0(
       pols_bhs$nome[i], 
       " (", pols_bhs$codONS[i], ") ",
       "Área: ",
       round(pols_bhs$adkm2[i]), 
       " km²"
       )
     )
plot(sf::st_geometry(pols_bhs),
     col = NA, 
     border = 'red', lwd = 2,
     add = TRUE
     )
plot(st_geometry(pols_bhs)[i], 
     add = TRUE, 
     col = 1
     )  
}
```

